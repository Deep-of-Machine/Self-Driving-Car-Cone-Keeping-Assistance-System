#!/usr/bin/env python3

import numpy as np
import rospy
from std_msgs.msg import Float64
import matplotlib.pyplot as plt
import matplotlib.animation as animation

# UTM 경로 (이미 변환된 UTM x, y 좌표)0


path_x = [302238.15449514333, 302238.1456235091, 302238.15449514333, 302238.1456235091, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.1456235091, 302238.1456235091, 302238.1456235091, 302238.15449514333, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.14536210685, 302238.1542337411, 302238.14536210685, 302238.14536210685, 302238.1542337411, 302238.14536210685, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.1542337411, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.15449514333, 302238.1456235091, 302238.15449514333, 302238.1456235091, 302238.15449514333, 302238.1456235091, 302238.1456235091, 302238.1456235091, 302238.1456235091, 302238.14614631346, 302238.14666911797, 302238.1474533245, 302238.14849893335, 302238.1409343104, 302238.14276412595, 302238.13598370994, 302238.13781352574, 302238.1323401191, 302238.1346927396, 302238.128173729, 302238.1310491542, 302238.12557574874, 302238.1203637484, 302238.11541315296, 302238.10446634726, 302238.0916897285, 302238.08830754773, 302238.0851867703, 302238.07345576223, 302238.0619861606, 302238.0510393677, 302238.040092572, 302238.0296685855, 302238.0195060036, 302238.009604824, 302237.9999650514, 302237.9817150549, 302237.97259809263, 302237.9637425355, 302237.9462767538, 302237.9379440078, 302237.9298726673, 302237.9220627326, 302237.9145142038, 302237.91583730315, 302237.90881158586, 302237.9106574938, 302237.90938265587, 302237.9028797549, 302237.9055098832, 302237.91701163596, 302237.9199031717, 302237.9319277344, 302237.93508067774, 302237.9382336235, 302237.941909379, 302237.936713518, 302237.9403892768, 302237.9443264464, 302237.9482636141, 302237.9527235945, 302237.95692217373, 302237.9613821595, 302237.9658421482, 302237.97056354355, 302237.97528494184, 302237.9802677472, 302237.9852505554, 302237.9813617526, 302237.9777343604, 302237.9741069727, 302237.97074099357, 302237.96737501887, 302237.96427045314, 302237.9609044851, 302237.95779992826, 302237.95495678077, 302237.9429806272, 302237.9401374896, 302237.9372943565, 302237.9347126331, 302237.9232593089, 302237.9206775958, 302237.91809588723, 302237.90690398746, 302237.9048450998, 302237.90252480947, 302237.90046593174, 302237.8986684644, 302237.9054811943, 302237.90368373645, 302237.9107578798, 302237.90922183706, 302237.9074243916, 302237.9147599534, 302237.91348533134, 302237.9119493088, 302237.9106746975, 302237.9005285003, 302237.8992538982, 302237.88936912024, 302237.888355938, 302237.8873427613, 302237.8863295879, 302237.8855778286, 302237.8848260749, 302237.89294591185, 302237.8921941685, 302237.88283225405, 302237.8823419273, 302237.8729800265, 302237.8636181331, 302237.8542562468, 302237.8451557727, 302237.83605530823, 302237.82695485116, 302237.8178543993, 302237.8090153645, 302237.8004377446, 302237.7918601325, 302237.78328252584, 302237.7838379101, 302237.7757831358, 302237.7677283696, 302237.7510634464, 302237.7432701051, 302237.726605203, 302237.7190732872, 302237.7115413797, 302237.7042708888, 302237.6970004042, 302237.689468522, 302237.6910696181, 302237.6840605689, 302237.6856616819, 302237.6872628017, 302237.68912533694, 302237.6909878793, 302237.69258901954, 302237.69471298234, 302237.6965755453, 302237.7073096712, 302237.7091722472, 302237.7112962394, 302237.7134202363, 302237.7152828332, 302237.71740684635, 302237.7195308667, 302237.72165489406, 302237.7149073797, 302237.7170314221, 302237.710545332, 302237.7037978433, 302237.69731177343, 302237.6908257126, 302237.68407824833, 302237.67759220535, 302237.67110617144, 302237.66488155694, 302237.66726707865, 302237.6610424815, 302237.6456849448, 302237.64833190164, 302237.64210733195, 302237.6270112361, 302237.6207866855, 302237.6148235552, 302237.61747055344, 302237.6115074408, 302237.6144158683, 302237.6170628918, 302237.6110998052, 302237.6140082536, 302237.6083065965, 302237.61121506314, 302237.60525201214, 302237.59955038014, 302237.5849772367, 302237.5790142148, 302237.564441093, 302237.54960656806, 302237.535033469, 302237.5204603812, 302237.50747228577, 302237.4842891196, 302237.46971607185, 302237.45514303533, 302237.44057000795, 302237.42599699425, 302237.4111625788, 302237.3963281723, 302237.38123236585, 302237.3661365705, 302237.35991229396, 302237.3445551038, 302237.3466795252, 302237.3396710348, 302237.349882734, 302237.3600944359, 302237.3692604918, 302237.3776423057, 302237.39384997124, 302237.41685440374, 302237.4307093483, 302237.4435186382, 302237.4469336029, 302237.4490415015, 302237.4594980688, 302237.4600374809, 302237.46866415086, 302237.4765065786, 302237.4746932682, 302237.4720957157, 302237.47758541664, 302237.4731579652, 302237.4768177663, 302237.47995473864, 302237.4820460537, 302237.47448163084, 302237.47526587395, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4838759543, 302237.4838759543, 302237.4750044596, 302237.4838759543, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4838759543, 302237.4838759543, 302237.4838759543, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4838759543, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4750044596, 302237.4838759543, 302237.4838759543, 302237.4838759543, 302237.4750044596, 302237.4838759543, 302237.4750044596, 302237.4750044596, 302237.4838759543, 302237.4838759543, 302237.49196320586, 302237.509444781, 302237.5180548637, 302237.50918336667, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.52692635625, 302237.5266649419, 302237.5180548637, 302237.5180548637, 302237.51779344934, 302237.51779344934, 302237.51779344934, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.5180548637, 302237.3121805751, 302237.3121805751, 302237.31191916054, 302237.31191916054, 302237.3121805751, 302237.3121805751, 302237.31191916054, 302237.3121805751]
path_y = [4123582.2765166257, 4123582.2767256238, 4123582.2765166257, 4123582.2767256238, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2767256238, 4123582.2767256238, 4123582.2767256238, 4123582.2765166257, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.2656295844, 4123582.265420585, 4123582.2656295844, 4123582.2656295844, 4123582.265420585, 4123582.2656295844, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.265420585, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2765166257, 4123582.2767256238, 4123582.2765166257, 4123582.2767256238, 4123582.2765166257, 4123582.2767256238, 4123582.2767256238, 4123582.2767256238, 4123582.2767256238, 4123582.298917704, 4123582.321109784, 4123582.354397901, 4123582.3987820596, 4123582.4544712575, 4123582.5321435337, 4123582.6211208496, 4123582.6987931263, 4123582.8432506397, 4123582.9431149964, 4123583.0431883517, 4123583.1652447865, 4123583.309702301, 4123583.4652558547, 4123583.6319054463, 4123583.9208204746, 4123584.132063225, 4123584.3652890543, 4123584.609610926, 4123584.865237836, 4123585.131960786, 4123585.420875814, 4123585.7097908417, 4123586.020897952, 4123586.3431010987, 4123586.6764002857, 4123587.020795514, 4123587.376495782, 4123587.743083088, 4123588.1207664367, 4123588.509754823, 4123588.90963025, 4123589.3206017157, 4123589.742669223, 4123590.1758327694, 4123590.6087873187, 4123591.0641429443, 4123591.5192895723, 4123592.2187580722, 4123592.6963057807, 4123593.1847405275, 4123593.6729662754, 4123594.1724970634, 4123594.6829148903, 4123595.193541719, 4123595.7041685474, 4123596.2369874553, 4123596.770015366, 4123597.3028342742, 4123597.8467492242, 4123598.3906641738, 4123598.956771204, 4123599.511782195, 4123600.0778892254, 4123600.6439962573, 4123601.2211993295, 4123601.7984023998, 4123602.386701513, 4123602.975000626, 4123603.56350874, 4123604.1631128932, 4123604.762717048, 4123605.373417244, 4123605.984117439, 4123606.605913674, 4123607.2166138724, 4123607.83841011, 4123608.471302387, 4123609.0933076255, 4123609.726199906, 4123610.359092185, 4123611.003080506, 4123611.647277827, 4123612.291266149, 4123612.93525447, 4123613.590547834, 4123614.256728239, 4123614.9118126025, 4123615.577993006, 4123616.255269453, 4123616.9212408573, 4123617.5985173043, 4123618.275584751, 4123618.963957238, 4123619.641233688, 4123620.329397177, 4123621.028865707, 4123621.717238199, 4123622.41670673, 4123623.116384264, 4123623.815852797, 4123624.5266263722, 4123625.237190948, 4123625.947755523, 4123626.658320101, 4123627.379980718, 4123628.101641336, 4123628.8230929542, 4123629.5447535734, 4123630.2777192355, 4123631.0104758968, 4123631.743441562, 4123632.4764072266, 4123633.2093728925, 4123633.9534345996, 4123634.697496307, 4123635.4415580165, 4123636.1856197263, 4123636.9407774783, 4123637.7070312696, 4123638.473285062, 4123639.2395388572, 4123640.0166796907, 4123640.8051255667, 4123641.593571444, 4123642.3933223663, 4123643.1928642867, 4123643.9926152094, 4123644.8032531734, 4123645.6138911364, 4123646.4356251415, 4123647.2573591485, 4123648.0679971157, 4123648.889522121, 4123649.7223521704, 4123650.5438771793, 4123651.365402187, 4123652.198023238, 4123653.030644289, 4123653.8521693014, 4123654.695886395, 4123655.5285074487, 4123656.360919501, 4123657.1935405578, 4123658.0372576555, 4123658.8809747547, 4123659.7135958145, 4123660.557312914, 4123661.4010300157, 4123662.244747119, 4123663.088673226, 4123663.932390332, 4123664.787412482, 4123665.6313385936, 4123666.4863607455, 4123667.3413828984, 4123668.185309013, 4123669.0403311695, 4123669.8953533256, 4123670.761471525, 4123671.61628468, 4123672.482402882, 4123673.3376340466, 4123674.203543246, 4123675.069661451, 4123675.9359886614, 4123676.802106868, 4123677.679321117, 4123678.545230322, 4123679.4224445713, 4123680.299449822, 4123681.1653590295, 4123682.0425732853, 4123682.9195785373, 4123683.807888835, 4123684.6848940896, 4123685.5621083486, 4123686.4504186497, 4123687.3389379582, 4123688.216152222, 4123689.1046715314, 4123689.982094801, 4123690.8706141138, 4123691.759133428, 4123693.091703396, 4123693.9915277585, 4123694.8800470773, 4123695.768566398, 4123696.657085718, 4123697.54560504, 4123698.423028323, 4123699.300451606, 4123700.1667788494, 4123701.033106094, 4123701.899224335, 4123702.7544555417, 4123703.598172696, 4123704.4310028167, 4123705.2412228435, 4123706.051442872, 4123706.817278735, 4123707.549826474, 4123708.2377810436, 4123709.2142326916, 4123709.8023228887, 4123710.3460289203, 4123710.8677518773, 4123711.333994624, 4123711.7778362837, 4123712.177502783, 4123712.543672153, 4123712.876553398, 4123713.176355525, 4123713.442869527, 4123713.6758863986, 4123713.8647281104, 4123714.020072692, 4123714.1532251905, 4123714.2419935223, 4123714.2976827356, 4123714.33097086, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.319665813, 4123714.319665813, 4123714.3198748175, 4123714.319665813, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.319665813, 4123714.319665813, 4123714.319665813, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.319665813, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.3198748175, 4123714.319665813, 4123714.319665813, 4123714.319665813, 4123714.3198748175, 4123714.319665813, 4123714.3198748175, 4123714.3198748175, 4123714.319665813, 4123714.319665813, 4123714.2861686824, 4123714.2746546296, 4123714.263349582, 4123714.263558588, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263140576, 4123714.2520445352, 4123714.263349582, 4123714.263349582, 4123714.252253541, 4123714.252253541, 4123714.252253541, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.263349582, 4123714.190484425, 4123714.190484425, 4123714.1793883843, 4123714.1793883843, 4123714.190484425, 4123714.190484425, 4123714.1793883843, 4123714.190484425]

# 실시간으로 업데이트될 IMU Yaw 값
current_yaw = 0.0


from pyproj import Proj
utm_proj = Proj(proj='utm', zone=52, ellps='WGS84')


# ROS 콜백 함수: Yaw 값을 업데이트
def imu_callback(data):
    global current_yaw
    current_yaw = data.data


def gps_callback(data):
    global x, y
    x, y = utm_proj(float(data.longitude), float(data.latitude))


# ROS 노드 초기화
rospy.init_node('imu_plotter', anonymous=True)

# ROS 토픽 구독
rospy.Subscriber("/filtered/imu/yaw", Float64, imu_callback)
rospy.Subscriber("/ublox_gps/fix", Float64, gps_callback)

# 그래프 설정
fig, ax = plt.subplots()
sc = ax.scatter(path_x, path_y, label='Path', color='b')

# 실시간 그래프 업데이트 함수
def update(frame):
    global current_yaw
    ax.clear()

    # 경로 표시
    ax.scatter(path_x, path_y, label='Path', color='b')

    # 현재 위치와 방향 (Yaw) 표시 (임의로 현재 위치를 설정함)
    current_x, current_y = path_x[0], path_y[0]  # 마지막 경로 포인트를 현재 위치로 가정

    # Yaw 값이 -pi에서 +pi 사이라고 가정
    # Yaw 방향을 화살표로 표시
    arrow_length = 20.0
    arrow_dx = arrow_length * np.cos(current_yaw)  # Yaw 값은 이미 라디안 단위
    arrow_dy = arrow_length * np.sin(current_yaw)  # Yaw 값은 이미 라디안 단위
    ax.arrow(current_x, current_y, arrow_dx, arrow_dy, head_width=1, head_length=1, fc='k', ec='k')

    ax.legend()
    ax.relim()
    ax.autoscale_view()

# 애니메이션
ani = animation.FuncAnimation(fig, update, frames=range(0, 100), blit=False, cache_frame_data=False)

plt.show()